@using GitHubRepoTrackerFE_Blazor.Interfaces
@using GitHubRepoTrackerFE_Blazor.Models
@using System.Linq
@page "/"
@inject IRepoService reposervice
@inject ILanguageService languageservice
@inject ITopicService topicservice


<PageTitle>Home</PageTitle>
<Header />

@if (repositories is not null && topics is not null && languages is not null)
{
    <div class="filters text-right">
        <label>Filter by Language:</label>
        <select @onchange="FilterByLanguage">
                <option value="Select" selected disabled="disabled">Choose Language</option>
                @foreach (var language in languages)
                {
                   
                    <option value="@language.languageName">@language.languageName</option>
                }
            </select>
   
        <label>Filter by Topics:</label>

        <select @onchange="FilterByTopic">
                <option value="Select" selected disabled="disabled">Choose Topic</option>

                @foreach (var topic in topics)
                {
                    <option value="@topic.topicName">@topic.topicName</option>
                }
        </select>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>RepoName</th>
                <th>Description</th>
                <th>Language</th>
                <th>Topics</th>
                <th>Last updated</th>
                <th>Stars</th>
                <th>Forks</th>
            </tr>
        </thead>
        <tbody>

            @foreach (var repo in repositories)
            {
                <tr>
                    <td>@repo.repositoryName</td>
                    <td>@repo.description</td>
                    <td>@repo.language.languageName</td>
                    
                    <td style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));">
                            @foreach (var topic in repo.repositoryTopics)
                            {
                            <div>@topic.topicName</div>
                            }
                    </td>
                    <td>@repo.updatedAt</td>
                    <td>@repo.forksCount</td>
                    <td>@repo.stargazersCount</td>
                </tr>
            }


        </tbody>
        

    </table>
}
    
else
{
        <p>Loading data...</p>
}

    


@code
{
    private List<Repository> repositories { get; set; }
    private List<Language> languages { get; set; }
    private List<Topic> topics { get; set; }

    string selectedLanguage = "";
    string selectedTopic = "";

}

@functions {
    protected override async Task OnInitializedAsync()
    {
        repositories = await reposervice.GetAllRepos();
        languages = await languageservice.GetAllLanguages();
        topics = await topicservice.GetAllTopics();

    
    }

    

    void FilterByLanguage(ChangeEventArgs e)
    {
        selectedLanguage = e.Value.ToString();
        FilterData();
    }

    void FilterByTopic(ChangeEventArgs e)
    {
        selectedTopic = e.Value.ToString();
        FilterData();
    }

    void FilterData()
    {
        repositories = repositories.Where(r =>
            (string.IsNullOrEmpty(selectedLanguage) || r.language.languageName == selectedLanguage) &&
            (string.IsNullOrEmpty(selectedTopic) || r.repositoryTopics.Any(t => t.topicName == selectedTopic))
        ).ToList();
        StateHasChanged();
    }

}


